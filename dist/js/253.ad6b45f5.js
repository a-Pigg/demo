"use strict";(self["webpackChunk_4010_assetweb"]=self["webpackChunk_4010_assetweb"]||[]).push([[253],{17386:function(t,e,i){i.d(e,{Z:function(){return p}});var r=function(){var t=this,e=t._self._c;return e("el-dialog",{directives:[{name:"loading",rawName:"v-loading",value:t.loading,expression:"loading"}],attrs:{"custom-class":"vPrintDialog",title:t.$t("h.title58"),fullscreen:"",visible:t.voucherPrintDialogVisible},on:{"update:visible":function(e){t.voucherPrintDialogVisible=e},closed:t.closedVoucherPrinter,opened:t.openVoucherPrinter}},[e("div",{staticClass:"box"},[e("div",{staticClass:"box-1"},[e("div",{staticClass:"tags"},[e("el-row",{attrs:{gutter:10}},t._l(t.pagMultipleSelection.slice((t.currentPage-1)*t.pageSize,t.currentPage*t.pageSize),(function(i,r){return e("el-col",{key:r,attrs:{xs:24,sm:12,lg:8}},[e("el-image",{attrs:{src:i,lazy:"","preview-src-list":t.pagMultipleSelection}})],1)})),1)],1),e("div",{staticClass:"pag"},[e("el-pagination",{attrs:{"current-page":t.currentPage,"page-sizes":[10,20,50],"page-size":t.pageSize,layout:"total, sizes, prev, pager, next, jumper",total:t.pagMultipleSelection.length},on:{"size-change":t.handleSizeChange,"current-change":t.handleCurrentChange}})],1)]),e("div",{directives:[{name:"loading",rawName:"v-loading",value:t.refreshLoading,expression:"refreshLoading"}],staticClass:"box-2"},[e("el-form",{ref:"printFormRef",attrs:{model:t.printForm,rules:t.printFormRules,"label-width":"100px"}},[e("el-form-item",{attrs:{label:t.$t("h.formTips1"),prop:"printName"}},[e("el-select",{attrs:{placeholder:t.$t("h.tips4")+t.$t("h.formTips1"),clearable:""},on:{change:t.printerSelectChange,clear:t.printSelectClear},model:{value:t.printForm.printName,callback:function(e){t.$set(t.printForm,"printName",e)},expression:"printForm.printName"}},t._l(t.printerSymbol,(function(t,i){return e("el-option",{key:i,attrs:{label:t.name,value:t.value}})})),1),e("el-popover",{attrs:{placement:"top-start",title:t.$t("h.formTips76"),width:"200",trigger:"hover"}},[e("div",[t._v(" "+t._s(t.$t("h.formTips77"))+":"+t._s(t.printerName)),e("br"),t._v(t._s(t.$t("h.formTips78"))+":"+t._s(t.printerType)+t._s(t.$t("h.formTips1"))+" ")]),e("img",{staticClass:"printerInfoIcon",attrs:{slot:"reference",src:i(78509),alt:t.$t("h.tips46")},slot:"reference"})]),e("i",{staticClass:"el-icon-refresh refresh_icon",on:{click:t.refreshPrinter}})],1),e("el-form-item",{attrs:{label:t.$t("h.formTips2")}},[e("el-input-number",{attrs:{min:1,precision:0,size:"small"},model:{value:t.printForm.printNum,callback:function(e){t.$set(t.printForm,"printNum",e)},expression:"printForm.printNum"}})],1),e("el-form-item",{attrs:{label:t.$t("h.formTips3"),prop:"moban"}},[e("el-select",{ref:"printTempSelectRef",attrs:{placeholder:t.$t("h.tips4")+t.$t("h.formTips3")},on:{change:t.templateSelectChange},model:{value:t.printForm.moban,callback:function(e){t.$set(t.printForm,"moban",e)},expression:"printForm.moban"}},t._l(t.voucherPrintTemplate,(function(t,i){return e("el-option",{key:i,attrs:{label:t.title,value:t._id}})})),1)],1),e("el-collapse",{attrs:{accordion:""},model:{value:t.activeNames,callback:function(e){t.activeNames=e},expression:"activeNames"}},[e("el-collapse-item",{attrs:{title:t.$t("h.formTips5"),name:"1"}},[e("el-form-item",{attrs:{label:t.$t("h.formTips6")}},[e("el-input-number",{attrs:{size:"small",precision:0},model:{value:t.printForm.transverse,callback:function(e){t.$set(t.printForm,"transverse",e)},expression:"printForm.transverse"}}),e("span",{staticStyle:{"margin-left":"10px","font-size":"12px"}},[t._v(t._s(t.$t("h.formTips7")))])],1),e("el-form-item",{attrs:{label:t.$t("h.formTips10")}},[e("el-input-number",{attrs:{size:"small",precision:0},model:{value:t.printForm.longitudinal,callback:function(e){t.$set(t.printForm,"longitudinal",e)},expression:"printForm.longitudinal"}}),e("span",{staticStyle:{"margin-left":"10px","font-size":"12px"}},[t._v(t._s(t.$t("h.formTips8")))])],1)],1)],1)],1),e("div",{staticClass:"box2_foot"},[e("el-button",{on:{click:function(e){t.voucherPrintDialogVisible=!1}}},[t._v(t._s(t.$t("h.cancelBtn")))]),e("el-button",{attrs:{type:"primary"},on:{click:t.startPrint}},[t._v(t._s(t.$t("h.confirmBtn")))])],1)],1)])])},s=[],n=(i(57658),i(82801),i(76080)),a=i(65762),o={data(){return{voucherPrintDialogVisible:!1,printerSymbol:[],printerName:"",printerType:"",pagMultipleSelection:[],printForm:{printName:"",printNum:"",moban:null,transverse:"",longitudinal:""},printFormRules:{printName:[{required:!0,message:this.$t("h.tips4")+this.$t("h.formTips1"),trigger:"change"}],moban:[{required:!0,message:this.$t("h.tips4")+this.$t("h.formTips19"),trigger:"change"}]},activeNames:["1"],ListIndex:"",facilityKey:"",printerDpi:"",body:{printLab:[]},NUMList:[],loading:!1,refreshLoading:!1,currentPage:1,pageSize:10,total:0,timer:null}},watch:{"printForm.printName"(t){""!=t&&(this.loading=!0,this.facilityKey?(0,n._u)({code:3,key:this.facilityKey}).then((e=>{this.facilityKey="",(0,n._u)({code:2,devType:"ESCP",param:t}).then((t=>{this.facilityKey=t.data,window.localStorage.setItem("voucherFacilityKey",t.data),this.getPrinterState(3)})).catch((t=>(this.loading=!1,this.$message(this.$t("h.tips53")))))})).catch((e=>{this.$message.error(this.$t("h.tips54")),(0,n._u)({code:2,devType:"ESCP",param:t}).then((t=>{this.facilityKey=t.data,window.localStorage.setItem("voucherFacilityKey",t.data),this.getPrinterState(3)})).catch((t=>(this.loading=!1,this.$message(this.$t("h.tips53")))))})):(0,n._u)({code:2,devType:"ESCP",param:t}).then((t=>{this.facilityKey=t.data,window.localStorage.setItem("voucherFacilityKey",t.data),this.getPrinterState(3)})).catch((t=>(this.loading=!1,this.$message(this.$t("h.tips53"))))))}},props:{voucherData:{type:Array,default(){return[]}},userInfo:{type:Object,default(){return{}}},voucherPrintTemplate:{type:Array,default(){return[]}},locationName:{type:String}},methods:{closedVoucherPrinter(){this.currentPage=1,this.pageSize=10,this.total=0,this.printerSymbol=[],this.pagMultipleSelection=[],this.facilityKey&&this.closePrintServer(this.facilityKey)},closePrintServer(t){(0,n._u)({code:3,key:t}).then((t=>{this.printForm.printName="",this.$message.success(this.$t("h.tips57"))})).catch((t=>{this.printForm.printName="",this.$message.error(this.$t("h.tips57"))}))},printSelectClear(){this.closePrintServer(this.facilityKey)},async openVoucherPrinter(){this.loading=!0;const t=window.localStorage.getItem("voucherFacilityKey");t&&(0,n._u)({code:3,key:t}),this.printForm.moban=parseInt(window.localStorage.getItem(this.locationName));const e=this.voucherPrintTemplate.find((t=>t._id==this.printForm.moban));for(let i=0;i<this.voucherData.length;i++){if(!this.voucherPrintDialogVisible){this.printerSymbol=[],this.pagMultipleSelection=[];break}await this.createVoucherTemplate(i,e)}(0,n._u)({code:1}).then((t=>{const e=new RegExp("MDL:"),i=new RegExp("CMD:"),r=[];for(let s=0;s<t.data.symbol.length;s++){const n=this.SplitDemo(t.data.symbol[s]);if(r.push(n),-1!=r[s][2].indexOf("DS")||-1!=r[s][2].indexOf(" DS")){this.printerName=r[s][2].replace(e,"");const n=r[s][1];this.printerType=n.replace(i,""),this.printerSymbol.push({name:this.printerName,value:t.data.symbol[s],deType:this.printerType})}}})).catch((t=>{if(void 0!=t.response)return 400==t.response.status?this.$notify.error({title:this.$t("h.title27"),message:this.$t("h.tips63")}):this.$notify.error({title:this.$t("h.title27"),message:this.$t("h.tips254")});this.$confirm(this.$t("h.tips61"),this.$t("h.title18"),{confirmButtonText:this.$t("h.confirmBtn"),cancelButtonText:this.$t("h.cancelBtn"),type:"warning"}).then((()=>{const t=document.createElement("a"),e="//120.197.55.79:6180/Release.zip";t.style.display="none",t.href=e,t.setAttribute("Release.zip",name),document.body.appendChild(t),t.click(),window.URL.revokeObjectURL(t.href),document.body.removeChild(t)})).catch((()=>{this.$message({type:"info",message:this.$t("h.tips62")})}))}))},refreshPrinter(){this.refreshLoading=!0,this.facilityKey&&this.closePrintServer(this.facilityKey),this.printForm.printName="",this.printerName="",this.printerType="",this.printerSymbol=[],(0,n._u)({code:1}).then((t=>{const e=new RegExp("MDL:"),i=new RegExp("CMD:"),r=[];for(let s=0;s<t.data.symbol.length;s++){const n=this.SplitDemo(t.data.symbol[s]);if(r.push(n),-1!=r[s][2].indexOf("DS")||-1!=r[s][2].indexOf(" DS")){this.printerName=r[s][2].replace(e,"");const n=r[s][1];this.printerType=n.replace(i,""),this.printerSymbol.push({name:this.printerName,value:t.data.symbol[s],deType:this.printerType})}}this.refreshLoading=!1,this.$message.success(this.$t("h.tips64"))})).catch((t=>{if(this.refreshLoading=!1,void 0!=t.response)return 400==t.response.status?this.$notify.error({title:this.$t("h.title27"),message:this.$t("h.tips63")}):this.$notify.error({title:this.$t("h.title27"),message:this.$t("h.tips254")});this.$confirm(this.$t("h.tips61"),this.$t("h.title18"),{confirmButtonText:this.$t("h.confirmBtn"),cancelButtonText:this.$t("h.cancelBtn"),type:"warning"}).then((()=>{const t=document.createElement("a"),e="//120.197.55.79:6180/Release.zip";t.style.display="none",t.href=e,t.setAttribute("Release.zip",name),document.body.appendChild(t),t.click(),window.URL.revokeObjectURL(t.href),document.body.removeChild(t)})).catch((()=>{this.$message({type:"info",message:this.$t("h.tips62")})}))}))},SplitDemo(t){let e=t.split(";");return e},async templateSelectChange(t){const e=this.voucherPrintTemplate.find((e=>e._id==t));this.pagMultipleSelection=[];for(let i=0;i<this.voucherData.length;i++){if(!this.voucherPrintDialogVisible){this.printerSymbol=[],this.pagMultipleSelection=[];break}await this.createVoucherTemplate(i,e)}},printerSelectChange(){this.printerSymbol.findIndex(((t,e)=>{this.ListIndex=e}))},getPrinterState(t){(0,n._u)({code:4,param:parseInt(t),key:this.facilityKey}).then((e=>{if(3==t){const t=e.data.DeviceDPI;this.printerDpi=null==t||void 0==t||""==t?203:t,this.loading=!1,this.$message.success(this.$t("h.tips51"))}})).catch((t=>(this.loading=!1,t)))},startPrint(){this.$refs["printFormRef"].validate((async t=>{if(!t)return!1;this.loading=!0,console.log(1,this.pagMultipleSelection);for(let e=0;e<this.pagMultipleSelection.length;e++)this.body.printLab[e]={tag:8,printDpi:parseInt(this.printerDpi),xOffset:parseInt(this.printForm.transverse),yOffset:parseInt(this.printForm.longitudinal),epcSect:"",userSect:"",resvSect:"",lockSect:"",datEncode:"Base64",datFmt:"Img",prnDats:this.pagMultipleSelection[e].split(",")[1]};if(this.NUMList=this.body.printLab,this.printForm.printNum>1)for(let e=0;e<this.printForm.printNum;e++)this.body.printLab=this.body.printLab.concat(this.NUMList);(0,n._u)({code:4,param:3,key:this.facilityKey}).then((t=>{"Ok"!=t.data.statInfo.devStat?(this.loading=!1,this.$notify.error({title:this.$t("h.title27"),message:this.$t("h.tips103")})):(console.log("this.body.printLab",this.body.printLab),console.log("JSON.stringify(this.body)",JSON.stringify(this.body)),(0,n.aJ)("post",{key:this.facilityKey,sendCode:"1"},this.base64Encode(JSON.stringify(this.body))).then((t=>{this.loading=!1,this.body.printLab=[],this.$notify.success({title:this.$t("h.tips103"),message:this.$t("h.tips104")})})).catch((t=>{this.loading=!1,this.$message.error(this.$t("h.tips105")),this.body.printLab=[]})))})).catch((t=>(this.loading=!1,this.$message.error(this.$t("h.tips106")))))}))},base64Encode(t){var e;return e=encodeURIComponent(t),e=unescape(e),e=window.btoa(e),e},async createVoucherTemplate(t,e){const i=document.createElement("canvas");let r=[];r=this.voucherData[t].list;const s=r.length;let n=1;if(s>7){n=parseInt(s/7),s%7!==0&&++n;const o=this.sliceIntoChunks(r,7);for(let r=0;r<n;r++){const s=await(0,a.B)(i,e,!0,this.voucherData[t],o[r]);this.pagMultipleSelection.push(s)}}else{const s=await(0,a.B)(i,e,!0,this.voucherData[t],r);this.pagMultipleSelection.push(s)}this.loading=!1},sliceIntoChunks(t,e){const i=[];for(let r=0;r<t.length;r+=e){const s=t.slice(r,r+e);i.push(s)}return i},handleSizeChange(t){this.pageSize=t},handleCurrentChange(t){this.currentPage=t}},created(){},destroyed(){}},l=o,h=i(1001),c=(0,h.Z)(l,r,s,!1,null,"76e9f5f0",null),p=c.exports},85117:function(t,e,i){var r=i(66330),s=TypeError;t.exports=function(t,e){if(!delete t[e])throw s("Cannot delete property "+r(e)+" of "+r(t))}},30541:function(t,e,i){var r=i(82109),s=i(47908),n=i(26244),a=i(83658),o=i(85117),l=i(7207),h=1!==[].unshift(0),c=!function(){try{Object.defineProperty([],"length",{writable:!1}).unshift()}catch(t){return t instanceof TypeError}}();r({target:"Array",proto:!0,arity:1,forced:h||c},{unshift:function(t){var e=s(this),i=n(e),r=arguments.length;if(r){l(i+r);var h=i;while(h--){var c=h+r;h in e?e[c]=e[h]:o(e,c)}for(var p=0;p<r;p++)e[p]=arguments[p]}return a(e,i+r)}})}}]);