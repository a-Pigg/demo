"use strict";(self["webpackChunk_4010_assetweb"]=self["webpackChunk_4010_assetweb"]||[]).push([[7937],{52086:function(e,t,s){s.d(t,{Z:function(){return d}});var i=function(){var e=this,t=e._self._c;return t("el-select",{ref:"selectRef",staticStyle:{width:"100%"},attrs:{clearable:"",filterable:"","filter-method":e.selectFilter,placeholder:e.placeholder,disabled:e.disabled,"value-key":e.defaultProps["value"],multiple:e.multiple,"collapse-tags":e.collapseTags},on:{clear:e.clearSelectValue,"remove-tag":e.removeSelectTag,focus:e.FocusSelect},model:{value:e.selectValue,callback:function(t){e.selectValue=t},expression:"selectValue"}},[t("el-option",{key:"x",attrs:{hidden:"",value:"x",label:"x"}}),e._l(e.valueData,(function(s,i){return t("el-option",{key:i,attrs:{hidden:"",value:s[e.defaultProps["value"]],label:s[e.defaultProps["label"]]}})})),e.multiple?t("el-checkbox",{staticStyle:{margin:"0 0 0 26px"},attrs:{"text-color":"#409EFF"},on:{change:e.checkboxChange},model:{value:e.checkedValue,callback:function(t){e.checkedValue=t},expression:"checkedValue"}},[e._v(e._s(e.$t("h.title52")))]):e._e(),e.multiple?t("div",{staticClass:"line"}):e._e(),t("el-tree",{ref:"treeRef",attrs:{"highlight-current":"","node-key":e.defaultProps["value"],data:e.treeData,props:e.defaultProps,"show-checkbox":e.multiple,"check-strictly":e.checkStrictly,"expand-on-click-node":e.isLastNode,"filter-node-method":e.treeFilterNode},on:{check:e.clickCheckBox,"node-click":e.clickNode},scopedSlots:e._u([{key:"default",fn:function({node:s,data:i}){return t("span",{staticClass:"tree-text"},[e._v(" "+e._s(i.code+"-"+s.label)+" ")])}}])})],2)},l=[],a=(s(57658),{data(){return{selectValue:null,valueData:[],checkedValue:!1}},props:{placeholder:{type:String,default:"请选择"},disabled:{type:Boolean,default:!1},treeData:{type:Array,default:()=>[]},defaultProps:{type:Object,default:()=>({value:"_id",label:"name",children:"children"})},multiple:{type:Boolean,default:!1},collapseTags:{type:Boolean,default:!1},checkStrictly:{type:Boolean,default:!1},isLastNode:{type:Boolean,default:!1},initData:{type:[Array,Number,String]},value:{type:[Array,Number,String]}},watch:{value:{handler(e){this.multiple?(this.selectValue=e,this.valueData=[],this.$nextTick((()=>{e instanceof Array==0?this.$refs.treeRef.setCheckedKeys([]):this.$refs.treeRef.setCheckedKeys(e);let t=this.$refs.treeRef.getCheckedNodes();this.valueData=t}))):(this.selectValue=e,this.valueData=[],this.$nextTick((()=>{this.$refs.treeRef.setCurrentKey(e);let t=this.$refs.treeRef.getCurrentNode();t&&this.valueData.push(t)})))},immediate:!0,deep:!0}},methods:{clearSelectValue(){this.multiple?this.selectValue=[]:this.selectValue=null,this.valueData=[],this.multiple?this.$refs.treeRef.setCheckedKeys([]):this.$refs.treeRef.setCurrentKey(null),this.$emit("input",this.selectValue),this.$emit("selectTree",this.selectValue)},removeSelectTag(e){if(!this.multiple)return!1;if(this.checkStrictly)this.valueData.splice(this.valueData.findIndex((t=>t[this.defaultProps.value]==e)),1),this.$nextTick((()=>{this.$refs.treeRef.setCheckedKeys(this.selectValue)}));else{this.valueData.splice(this.valueData.findIndex((t=>t[this.defaultProps.value]==e)),1);let t=this.$refs.treeRef.getCheckedNodes(!0,!1);for(let s=0;s<t.length;s++)if(t[s][this.defaultProps.value]==e){t.splice(s,1);break}this.$nextTick((()=>{this.$refs.treeRef.setCheckedNodes(t)}))}this.$emit("input",this.selectValue),this.$emit("selectTree",this.selectValue)},FocusSelect(){this.$refs.treeRef.filter("")},clickCheckBox(e,t){if(this.checkStrictly)if(e.children&&0!=e.children.length){const s=e[this.defaultProps.value];if(-1!=this.selectValue.indexOf(s))this.selectValue.splice(this.selectValue.findIndex((e=>e==s)),1),this.valueData.splice(this.valueData.findIndex((e=>e[this.defaultProps.value]==s)),1),this.$refs.treeRef.setCheckedKeys(this.selectValue);else{let s=this.lookForAllId(e.children),i=this.lookForAll(e.children);this.valueData=this.dsNewSet([...t.checkedNodes,...i],!0),this.selectValue=this.dsNewSet([...t.checkedKeys,...s],!1),this.$refs.treeRef.setCheckedKeys(this.selectValue)}}else this.valueData=t.checkedNodes,this.selectValue=t.checkedKeys,this.$refs.treeRef.setCheckedKeys(this.selectValue);else 0==t.halfCheckedKeys.length?(this.valueData=t.checkedNodes,this.selectValue=t.checkedKeys):(this.valueData=[...t.checkedNodes,...t.halfCheckedNodes],this.selectValue=[...t.checkedKeys,...t.halfCheckedKeys]);this.$emit("input",this.selectValue),this.$emit("selectTree",this.selectValue)},clickNode(e,t,s){if(this.multiple)return!1;if(this.isLastNode){if(null!=e.children)return!1;this.selectValue=e[this.defaultProps.value],this.valueData=[e],this.$refs.treeRef.setCurrentKey(e[this.defaultProps.value])}else this.selectValue=e[this.defaultProps.value],this.valueData=[e],this.$refs.treeRef.setCurrentKey(e[this.defaultProps.value]);this.$emit("input",this.selectValue),this.$emit("selectTree",this.selectValue,e),this.$refs.selectRef.blur()},removeNode(e){this.$refs.treeRef.remove(e)},lookForAllId(e=[],t=[]){for(let s of e)t.push(s[this.defaultProps.value]),s.children&&s.children.length&&this.lookForAllId(s.children,t);return t},lookForAll(e=[],t=[]){for(let s of e)t.push(s),s.children&&s.children.length&&this.lookForAll(s.children,t);return t},dsNewSet(e,t){if(t){const t=new Map;return e.filter((e=>!t.has(e[this.defaultProps.value])&&t.set(e[this.defaultProps.value],1)))}for(var s=0;s<e.length;s++)for(var i=s+1;i<e.length;i++)e[s]==e[i]&&e.splice(i,1);return e},selectFilter(e){this.$refs.treeRef.filter(e)},treeFilterNode(e,t){return!e||-1!==t[this.defaultProps.label].indexOf(e)},checkboxChange(e){e?(this.valueData=this.lookForAll(this.treeData),this.selectValue=this.lookForAllId(this.treeData),this.$refs.treeRef.setCheckedKeys(this.lookForAllId(this.treeData))):(this.$refs.treeRef.setCheckedKeys([]),this.selectValue=null,this.valueData=[]),this.$emit("input",this.selectValue),this.$emit("selectTree",this.selectValue)}}}),o=a,r=s(1001),n=(0,r.Z)(o,i,l,!1,null,"1a3a05b9",null),d=n.exports},28972:function(e,t,s){s.r(t),s.d(t,{default:function(){return q}});var i=function(){var e=this,t=e._self._c;return t("div",{staticClass:"requisition"},[t("el-card",{staticClass:"requisition-card"},[t("div",{staticClass:"requisition-card-header",attrs:{slot:"header"},slot:"header"},[t("ds-query-form",[t("ds-query-form-left-panel",[t("el-button",{attrs:{size:"small",type:"primary"},on:{click:e.newRequisitionForm}},[e._v(e._s(e.$t("h.newBtn")))]),t("el-dropdown",{attrs:{trigger:"click"}},[t("el-button",{attrs:{size:"small"}},[e._v(" "+e._s(e.$t("h.editBtn"))),t("i",{staticClass:"el-icon-arrow-down el-icon--right"})]),t("el-dropdown-menu",{attrs:{slot:"dropdown"},slot:"dropdown"},[t("el-dropdown-item",[e._v(e._s(e.$t("h.changeBtn")))]),t("el-dropdown-item",[e._v(e._s(e.$t("h.delBtn")))])],1)],1),t("el-dropdown",{attrs:{trigger:"click"}},[t("el-button",{attrs:{size:"small"}},[e._v(" "+e._s(e.$t("h.formTips5"))),t("i",{staticClass:"el-icon-arrow-down el-icon--right"})]),t("el-dropdown-menu",{attrs:{slot:"dropdown"},slot:"dropdown"},[t("el-dropdown-item",[e._v(e._s(e.$t("h.printDoucmentBtn")))]),t("el-dropdown-item",[e._v(e._s(e.$t("h.templateSettings")))])],1)],1)],1),t("ds-query-form-right-panel",[t("ds-search-btn")],1)],1)],1),t("div",{staticClass:"requisition-card-content"},[t("div",{staticClass:"requisition-filter"},[t("el-button",{staticClass:"advanced-filter-btn",attrs:{type:"text",size:"small"}},[e._v(e._s(e.$t("h.advancedBtn")))])],1),t("div",{staticClass:"requisition-table"},[t("ds-table",{ref:"billsTableRef",attrs:{loading:e.tableLoading,tableData:e.requisitionBills,columns:e.requisitionBillsColumns,tableConfig:e.requisitionBillsConfig,rowKey:e=>e.id}})],1),t("div",{staticClass:"requisition-pagination"},[t("ds-pagination",{attrs:{small:"",total:e.total,page:e.paginationForm.currentPage,limit:e.paginationForm.pageSize},on:{"update:page":function(t){return e.$set(e.paginationForm,"currentPage",t)},"update:limit":function(t){return e.$set(e.paginationForm,"pageSize",t)},pagination:e.getRequisitionBills}})],1)])]),t("new-bills-dialog",{staticClass:"new-bill-dialog",attrs:{newBillsDialogVisible:e.newBillsDialogVisible},on:{"update:newBillsDialogVisible":function(t){e.newBillsDialogVisible=t},"update:new-bills-dialog-visible":function(t){e.newBillsDialogVisible=t},opened:e.newBillsDialogOpened,close:e.newBillsDialogClose,sbumitForm:e.sbumitRequisitionForm}},[t("template",{slot:"form"},[t("el-form",{ref:"requisitonFormRef",attrs:{"label-width":"100px",model:e.requisitionForm,rules:e.requisitionRules}},[t("el-row",{attrs:{gutter:20}},[t("el-col",{attrs:{span:12}},[t("el-form-item",{attrs:{label:e.$t("h.applicationDate"),prop:"date"}},[t("el-date-picker",{attrs:{type:"date","value-format":"yyyy-MM-dd",placeholder:e.$t("h.tips4")+e.$t("h.applicationDate")},model:{value:e.requisitionForm.date,callback:function(t){e.$set(e.requisitionForm,"date",t)},expression:"requisitionForm.date"}})],1)],1),t("el-col",{attrs:{span:12}},[t("el-form-item",{attrs:{label:e.$t("h.assetAttributes"),prop:"goodsId"}},[t("el-select",{attrs:{placeholder:e.$t("h.tips4")+e.$t("h.assetAttributes"),filterable:"",clearable:""},model:{value:e.requisitionForm.goodsId,callback:function(t){e.$set(e.requisitionForm,"goodsId",t)},expression:"requisitionForm.goodsId"}},e._l(e.goodsData,(function(e){return t("el-option",{key:e.goodsqId,attrs:{label:e.name,value:e.goodsqId}})})),1)],1)],1),t("el-col",{attrs:{span:12}},[t("el-form-item",{attrs:{label:e.$t("h.applicant"),prop:"staffId"}},[t("el-select",{directives:[{name:"load-more",rawName:"v-load-more",value:{options:e.staffData,modelField:"_id",model:e.requisitionForm.staffId,searchField:"andLike",func:"S0005",userInfo:e.userInfo},expression:"{\n                  options: staffData,\n                  modelField: '_id',\n                  model: requisitionForm.staffId,\n                  searchField: 'andLike',\n                  func: 'S0005',\n                  userInfo: userInfo,\n                }"}],attrs:{disabled:"",placeholder:e.$t("h.tips4")+e.$t("h.applicant"),clearable:"",filterable:"","filter-method":()=>{}},model:{value:e.requisitionForm.staffId,callback:function(t){e.$set(e.requisitionForm,"staffId",t)},expression:"requisitionForm.staffId"}},e._l(e.staffData,(function(s){return t("el-option",{key:s._id,attrs:{label:s.name,value:s._id}},[t("span",[e._v(e._s(s.name+"("+s.code+")")+" -"+e._s(s.deptName))])])})),1)],1)],1),t("el-col",{attrs:{span:12}},[t("el-form-item",{attrs:{label:e.$t("h.supplier"),prop:"vendorId"}},[t("el-select",{attrs:{placeholder:e.$t("h.tips4")+e.$t("h.supplier"),filterable:"",clearable:""},model:{value:e.requisitionForm.vendorId,callback:function(t){e.$set(e.requisitionForm,"vendorId",t)},expression:"requisitionForm.vendorId"}},e._l(e.vendorData,(function(e){return t("el-option",{key:e.id,attrs:{label:e.name,value:e.id}})})),1)],1)],1),t("el-col",{attrs:{span:12}},[t("el-form-item",{attrs:{label:e.$t("h.receivingInformation"),prop:"receiveAddress"}},[t("el-input",{attrs:{placeholder:e.$t("h.tips3")+e.$t("h.receivingInformation")},model:{value:e.requisitionForm.receiveAddress,callback:function(t){e.$set(e.requisitionForm,"receiveAddress",t)},expression:"requisitionForm.receiveAddress"}})],1)],1),t("el-col",{attrs:{span:12}},[t("el-form-item",{attrs:{label:e.$t("h.formTips43"),prop:"desireDate"}},[t("el-date-picker",{attrs:{type:"date",format:"yyyy 年 MM 月 dd 日","value-format":"yyyy-MM-dd",placeholder:e.$t("h.tips4")+e.$t("h.formTips43")},model:{value:e.requisitionForm.desireDate,callback:function(t){e.$set(e.requisitionForm,"desireDate",t)},expression:"requisitionForm.desireDate"}})],1)],1),t("el-col",{attrs:{span:24}},[t("el-form-item",{attrs:{label:e.$t("h.formTips44"),prop:"coment"}},[t("el-input",{attrs:{type:"textarea"},model:{value:e.requisitionForm.coment,callback:function(t){e.$set(e.requisitionForm,"coment",t)},expression:"requisitionForm.coment"}})],1)],1)],1)],1)],1),t("template",{slot:"btns"},[t("div",[t("span",{staticClass:"title"},[e._v(e._s(e.$t("h.title146"))+" - "+e._s(e.$t("h.title147")))])]),t("div",{staticClass:"btns"},[t("el-button",{attrs:{type:"text",size:"small"},on:{click:function(t){e.skuDialogVisible=!0}}},[e._v(e._s(e.$t("h.addBtn")))]),t("el-button",{attrs:{type:"text",size:"small"},on:{click:e.deleteApplyGoods}},[e._v(e._s(e.$t("h.delBtn")))])],1)]),t("template",{slot:"table"},[t("div",{staticClass:"bill-table"},[t("ds-table",{ref:"applyGoodsTableRef",attrs:{tableConfig:e.requisitionBillsConfig,columns:e.applyGoodsColumns,tableData:e.applyGoods,rowKey:e=>e.proId,sums:e.sums,summary:""},on:{getSummaries:e.getSummaries,handleSelectionChange:e.applyGoodsSelectionChange},scopedSlots:e._u([{key:"price",fn:function({scope:s}){return[t("span",[t("el-input",{attrs:{size:"mini"},on:{blur:t=>e.onPriceChange(t,s.row)},model:{value:s.row.price,callback:function(t){e.$set(s.row,"price",t)},expression:"scope.row.price"}})],1)]}},{key:"quantity",fn:function({scope:s}){return[t("span",[t("el-input-number",{attrs:{precision:2,step:1,min:1,size:"mini"},on:{change:(t,i)=>e.onQuantityChange(t,i,s.row)},model:{value:s.row.quantity,callback:function(t){e.$set(s.row,"quantity",t)},expression:"scope.row.quantity"}})],1)]}},{key:"amount",fn:function({scope:s}){return[t("span",[t("el-input",{attrs:{size:"mini"},on:{blur:t=>e.onAmountChange(t,s.row)},model:{value:s.row.amount,callback:function(t){e.$set(s.row,"amount",t)},expression:"scope.row.amount"}})],1)]}}])})],1)])],2),t("sku-list-dialog",{attrs:{skuDialogVisible:e.skuDialogVisible,updateSkuSelectState:e.applyGoods},on:{"update:skuDialogVisible":function(t){e.skuDialogVisible=t},"update:sku-dialog-visible":function(t){e.skuDialogVisible=t},save:e.skuSelectionChange}})],1)},l=[],a=(s(57658),s(20629)),o=s(76080),r=s(83151),n=s(55886),d=s(52086),u=s(42041),c=s(19698),h=s(92003),p=s(89782),f=s(66403),m=s(60983),g=s(93082),v=s(40466),b={components:{DsTable:m.Z,DsSelectTree:d.Z,DsSearchBtn:f.Z,DsQueryForm:c.Z,DsPagination:g.Z,NewBillsDialog:u.Z,SkuListDialog:v.Z,DsQueryFormLeftPanel:h.Z,DsQueryFormRightPanel:p.Z},data(){return{tableLoading:!1,requisitionBillsConfig:{selection:!0,reserveSelection:!0},requisitionBillsColumns:r.hf,total:0,paginationForm:{currentPage:1,pageSize:20},requisitionBills:[],deptTreeProps:{value:"_id",label:"deptName",children:"children"},depts:[],treeDepts:[],staffData:[],goodsData:[],vendorData:[],newBillsDialogVisible:!1,dialogLoading:{target:".new-bill-dialog",spinner:"el-icon-loading",background:"rgba(0, 0, 0, 0.7)"},requisitionForm:{staffId:"",goodsId:"",desireDate:"",date:"",coment:"",receiveAddress:"",vendorId:"",permissonId:26},requisitionRules:{goodsId:[{required:!0,message:this.$t("h.tips4")+this.$t("h.assetAttributes"),trigger:"change"}],vendorId:[{required:!0,message:this.$t("h.tips4")+this.$t("h.supplier"),trigger:"change"}]},applyGoodsColumns:r.By,applyGoods:[],selectApplyGoods:[],skuDialogVisible:!1,sums:[]}},computed:{...(0,a.rn)(["userInfo"])},directives:{focus:{inserted:function(e){e.querySelector("input").focus()}}},methods:{getRequisitionBills(){this.tableLoading=!0,(0,o.Ys)({func:"S0059",userId:this.userInfo._id,token:this.userInfo.token,requstData:{page:this.paginationForm.pageSize,index:this.paginationForm.currentPage}}).then((({data:e})=>{if(console.log(e.data),this.tableLoading=!1,0!=e.code)return this.$message.error(e.data);this.total=e.data[0],this.requisitionBills=e.data[1],this.requisitionBills.forEach((e=>{let t=[];e.details.forEach((e=>{t.push(e.skuName)})),e.goodDetails=t.join("/")}))})).catch((()=>{this.tableLoading=!1,this.$message.error(this.$t("h.tips18"))}))},getDepts(){(0,o.Ys)({func:"S0004",userId:this.userInfo._id,token:this.userInfo.token,requstData:{}}).then((({data:e})=>{if(0!=e.code)return this.$message.error(e.data);this.depts=e.data,this.treeDepts=(0,n.M)(e.data,null)})).catch((()=>{this.$message.error(this.$t("h.tips18"))}))},getGoods(){(0,o.Ys)({func:"S0022",userId:this.userInfo._id,token:this.userInfo.token,requstData:{}}).then((({data:e})=>{if(0!=e.code)return this.$message.error(e.data);this.goodsData=e.data})).catch((()=>{this.$message.error(this.$t("h.tips18"))}))},getVendors(){(0,o.Ys)({func:"S0061",userId:this.userInfo._id,token:this.userInfo.token,requstData:{}}).then((({data:e})=>{if(0!=e.code)return this.$message.error(e.data);this.vendorData=e.data[1]})).catch((()=>{this.$message.error(this.$t("h.tips18"))}))},newRequisitionForm(){this.newBillsDialogVisible=!0,this.requisitionForm.staffId=this.userInfo._id},newBillsDialogOpened(){this.$refs.requisitonFormRef.clearValidate()},newBillsDialogClose(){this.applyGoods=[],this.selectApplyGoods=[],this.sums=[],this.requisitionForm.staffId="",this.requisitionForm.goodsId="",this.requisitionForm.desireDate="",this.requisitionForm.date="",this.requisitionForm.coment="",this.requisitionForm.receiveAddress="",this.requisitionForm.vendorId=""},sbumitRequisitionForm(){this.$refs.requisitonFormRef.validate((e=>{if(!e)return!1;if(!this.applyGoods.length)return this.$notify.error({title:this.$t("h.title27"),message:this.$t("h.tips18")});let t=!1;for(let l=0;l<this.applyGoods.length;l++)if(!this.applyGoods[l].quantity){t=!0;break}if(t)return this.$notify.error({title:this.$t("h.title27"),message:this.$t("h.tips3")+this.$t("h.columns29")});const s=this.$loading(this.dialogLoading);let i=this.staffData.find((e=>e._id==this.userInfo._id)).deptId;(0,o.Vx)({func:"U0066",token:this.userInfo.token,userId:this.userInfo._id,requstData:{deptId:i,staffId:this.requisitionForm.staffId,goodsId:this.requisitionForm.goodsId,desireDate:this.requisitionForm.desireDate,date:this.requisitionForm.date,coment:this.requisitionForm.coment,receiveAddress:this.requisitionForm.receiveAddress,vendorId:this.requisitionForm.vendorId,details:this.applyGoods,permissonId:95}}).then((({data:e})=>{if(s.close(),0!=e.code)return this.$message.error(e.data);this.$message.success(e.data),this.newBillsDialogVisible=!1,this.paginationForm.currentPage=1,this.getRequisitionBills()})).catch((()=>{s.close(),this.$message.error(this.$t("h.tips18"))}))}))},onQuantityChange(e,t,s){s.price&&this.$set(s,"amount",s.amount=(s.price*s.quantity).toFixed(2))},onPriceChange(e,t){let s=/^(([1-9][0-9]*)|(([0]\.\d{1,2}|[1-9][0-9]*\.\d{1,2})))$/;if(!s.test(t.price))return t.price=null,this.$message.error(this.$t("h.tips251"));t.quantity&&this.$set(t,"amount",t.amount=(t.price*t.quantity).toFixed(2))},onAmountChange(e,t){let s=/^(([1-9][0-9]*)|(([0]\.\d{1,2}|[1-9][0-9]*\.\d{1,2})))$/;if(!s.test(t.amount))return t.amount=null,this.$message.error(this.$t("h.tips251"));t.quantity&&t.amount&&this.$set(t,"price",t.price=(t.amount/t.quantity).toFixed(2))},skuSelectionChange(e){this.applyGoods=e.map((e=>({proId:e.id,price:e.amount,assetTemplateName:e.assetTemplateName,measureUnit:e.measureUnit,specification:e.specification,amount:null}))),this.skuDialogVisible=!1},deleteApplyGoods(){this.selectApplyGoods.forEach((e=>{this.applyGoods.splice(this.applyGoods.findIndex((t=>t.proId===e.proId)),1)})),this.$refs.applyGoodsTableRef.$refs.dsTableRef.clearSelection()},applyGoodsSelectionChange(e){this.selectApplyGoods=e},getSummaries(e){const{columns:t,data:s}=e;t.forEach(((e,t)=>{if(0===t)return void(this.sums[t]=this.$t("h.totalAmount"));const i=s.map((t=>Number(t[e.property])));i.every((e=>isNaN(e)))?this.sums[t]="N/A":(this.sums[t]=i.reduce(((e,t)=>{const s=Number(t);return isNaN(s)?e:e+t}),0),this.sums[t]+=` ${this.$t("h.totalAmount")}`)}))}},created(){this.getRequisitionBills(),this.getDepts(),this.getGoods(),this.getVendors()}},$=b,k=s(1001),y=(0,k.Z)($,i,l,!1,null,"0130e8a9",null),q=y.exports}}]);